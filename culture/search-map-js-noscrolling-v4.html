<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문화충전</title>
    <link rel="stylesheet" href="./assets/scss/reset.scss">
    <link rel="stylesheet" href="../culture/assets/assets-ha/css/style.min.css">
    <link rel="shortcut icon" href="assets/favicon/bolt-solid.ico">
    <script src="https://kit.fontawesome.com/4691863309.js" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <div data-include="./inc/header.html"></div>
    </header>

    <main>
        <!-- form -->
        <!-- 장르, 지역 선택 -->
        <form action="#" id="searchForm">
            <fieldset>
                <select name="search_genre" id="search_genre">
                    <option value="장르">장르</option>
                    <option value="무용">무용</option>
                    <option value="뮤지컬">뮤지컬</option>
                    <option value="연극">연극</option>
                    <option value="오페라">오페라</option>
                    <option value="콘서트">콘서트</option>
                    <option value="클래식">클래식</option>
                    <option value="기타">기타</option>
                </select>
                <!-- <select name="search_area" id="search_area">
                    <option value="all">지역</option>
                    <option value="37.5666805,126.9784147">서울특별시</option>
                    <option value="35.17944,129.07556">부산광역시</option>
                    <option value="35.87222,128.60250">대구광역시</option>
                    <option value="37.45639,126.70528">인천광역시</option>
                    <option value="35.15972,126.85306">광주광역시</option>
                    <option value="36.35111,127.38500">대전광역시</option>
                    <option value="35.53889,129.31667">울산광역시</option>
                    <option value="36.48750,127.28167">세종특별자치시</option>
                    <option value="37.567167,127.190292">경기도</option>
                    <option value="37.555837,128.209315">강원도</option>
                    <option value="36.628503,127.929344">충청북도</option>
                    <option value="36.557229,126.779757">충청남도</option>
                    <option value="35.716705,127.144185">전라북도</option>
                    <option value="34.819400,126.893113">전라남도</option>
                    <option value="36.248647,128.664734">경상북도</option>
                    <option value="35.259787,128.664734">경상남도</option>
                    <option value="33.50000,126.51667">제주특별자치도</option>
                </select> -->
                <input type="search" id="query" placeholder="공연제목 또는 공연장 입력">
                <button type="submit">검색</button>
            </fieldset>
        </form>

        <form action="#" id="map_list">
                <ul id="map_buttons">
                    <li><button onclick="buttonClick(this.value)" type="button" id="a" value="37.5666805,126.9784147">서울특별시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="b" value="35.17944,129.07556">부산광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="c" value="35.87222,128.60250">대구광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="d" value="37.45639,126.70528">인천광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="e" value="35.15972,126.85306">광주광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="f" value="36.35111,127.38500">대전광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="g" value="35.53889,129.31667">울산광역시</button></li>
                    <li><button onclick="buttonClick(this.value)" type="button" id="h" value="36.48750,127.28167">세종특별자치시</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="i" value="37.567167,127.190292">경기도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="j" value="37.555837,128.209315">강원도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="k" value="36.628503,127.929344">충청북도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="l" value="36.557229,126.779757">충청남도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="m" value="35.716705,127.144185">전라북도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="n" value="34.819400,126.893113">전라남도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="o" value="36.248647,128.664734">경상북도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="p" value="35.259787,128.664734">경상남도</button></li>
                    <li><button onclick="buttonClickDo(this.value)" type="button" id="q" value="33.50000,126.51667">제주특별자치도</button></li>
                </ul>
        </form>

        <!-- 지도 표시 -->
        <div id="map" style="width:750px;height:400px;"></div>

        <!-- 상세 -->
        <div id="detail"></div>

        <!-- show 추천 항목 리스트 -->
        <div id="show">
            <ul id="show_list">
            </ul>
        </div>
    </main>

    <!-- footer -->
    <footer>
        <div data-include="./inc/footer.html"></div>
    </footer>

    <!-- 스크립트 -->
    <script src="../node_modules/axios/dist/axios.min.js"></script>
    <script src="./assets/js/include.js"></script>
    <!-- key등록 / services와 clusterer, drawing 라이브러리 불러오기 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8b69768f7e98a4a1d4489b836f6a8972&libraries=services,clusterer,drawing"></script>

    <script>
        // kakao rest key
        const KAKAO_REST_KEY = 'b204b408f1f9390af9b568c47045350e';

        /** 
         * 
         * 
         * 변수
        */
        let searchGenre = null;
        let searchArea = null;
        
        let queryKeyword = null;

        // 위도 경도
        // let lngLocation = null;
        // let latLocation = null;
        var Lat = 0;
        var Lng = 0;

        var doLat = 0;
        var doLng = 0;

        /** 
         * 
         * 
         * 양식 submit시 변수 할당과 search(), setCenter() 실행
         */
        document.querySelector('#searchForm').addEventListener('submit', e => {
            e.preventDefault();

            const genreField = document.querySelector('#search_genre');
            genre = genreField[genreField.selectedIndex].value;
            
            // const areaLatLng = document.querySelector('#search_area');
            // if (areaLatLng.selectedIndex < 9) {
            //     let location = areaLatLng[areaLatLng.selectedIndex].value;
            //     let locationS = location.split(',');
            //     Array.from(locationS);
            //     Lat = locationS[0];
            //     Lng = locationS[1];
            //     setCenter();
            // } else {
            //     let location = areaLatLng[areaLatLng.selectedIndex].value;
            //     let locationS = location.split(',');
            //     Array.from(locationS);
            //     doLat = locationS[0];
            //     doLng = locationS[1];
            //     setCenterOut();
            // }
            const queryField = document.querySelector('#query');
            queryKeyword = queryField.value.trim();

            // if (!queryKeyword) {
            //     alert('검색어를 입력하세요.');
            //     queryField.focus();
            //     return;
            // }

            search();
        });


        function buttonClick (value) {
                let locationS = value.split(',');
                Array.from(locationS);
                Lat = locationS[0];
                Lng = locationS[1];
                setCenter();
        }

        function buttonClickDo (valueDo) {
                let locationS = valueDo.split(',');
                Array.from(locationS);
                doLat = locationS[0];
                doLng = locationS[1];
                setCenterOut();
        }
        
        /**
         * 
         * 
         * 지도 이동시키기
         */
        // 시 지역 줌 레벨 7
        function setCenter() {            
            // 이동할 위도 경도 위치를 생성합니다 
            var moveLatLon = new kakao.maps.LatLng(Lat, Lng);
            // 지도 중심을 이동 시킵니다
            map.setCenter(moveLatLon);
            // 줌 레벨 설정
            zoomIn();
            // 줌 인 아웃 여부
            setZoomable(false);
        }
        // 도 지역 줌 레벨 10
        function setCenterOut() {            
            // 이동할 위도 경도 위치를 생성합니다 
            var moveLatLon = new kakao.maps.LatLng(doLat, doLng);
            // 지도 중심을 이동 시킵니다
            map.setCenter(moveLatLon);
            // 줌 레벨 설정
            zoomOut();
            // 줌 인 아웃 여부
            setZoomable(false);
        }

        /** 
         * 
         * 
         * 장르 선택
         * 장르 필터링 및 해당 json data 구현
         */
        async function search() {
            const list = document.querySelector('#show_list');

            // 검색시 추천 항목 제거
            Array.from(list.getElementsByTagName('li')).forEach((v, i) => {
                list.removeChild(v);
            });
            
            let json = null;

            try {
                // test json
                const response = await axios.get('http://localhost:3001/response');
                json = response.data.body.items.item;
                // console.log(json);

                // API JSON ------------- 수정
                // const response = await axios.get('http://api.kcisa.kr/openapi/service/rest/meta16/getkopis01', {
                //     params: {
                //         serviceKey: "b5c0289f-a465-4bd4-bb80-37b3b12a1150",
                //         numOfRows: 5,
                //         pageNo: 1,
                //     },
                //     header: {
                //         accept: "application/json",
                //     },
                // });
                // json = response.data.response.body.items.item;
                // console.log(json);
            } catch (error) {
                console.error(`[Error Code] ${error.code}`);
                console.error(`[Error Message] ${error.message}`);
                let alertMsg = error.message;

                if (error.response !== undefined) {
                    const errorMsg = `${error.response.status} error - ${error.response.statusText}`;
                    console.error(`[HTTP Status] ${errorMsg}`);
                    alertMsg += `\n${errorMsg}`;
                }
                alert(alertMsg);
                return;
            }
            // console.log(genre);
            // console.log(json);

            // console.log(response);

            // 일정 개수만 출력하기 위한 변수 지정
            let j = 0;
            // 장르 필터링 및 해당 json data 구현
            json.some((v, i) => {
                // const genre = v.subjectCategory;
                // console.log(v);
                if (v.subjectCategory == genre) {
                    // 태그 생성
                    let li = document.createElement("li");
                    let a = document.createElement("a");
                    let div = document.createElement("div");
                    let img = document.createElement("img")
                    let h3 = document.createElement("h3")
                    let h4 = document.createElement("h4")
                    let p = document.createElement("p")

                    // 태그 속성 추가
                    li.classList.add("recommend_item")
                    a.setAttribute("href", v.url);
                    a.setAttribute("target", "_blank");
                    img.setAttribute("src", v.referenceIdentifier);

                    // 태그 데이터 추가
                    h3.innerHTML = v.title;
                    h4.innerHTML = v.spatialCoverage;
                    p.innerHTML = v.temporalCoverage;

                    // show에 하위 요소로 추가
                    div.appendChild(img);
                    div.appendChild(h3);
                    div.appendChild(h4);
                    div.appendChild(p);
                    a.appendChild(div);
                    li.appendChild(a);
                    // h3: 20, h4: 18, h5: 14, img: 200 x 250
                    document.querySelector('#show_list').appendChild(li);
                    j++;
                } else if (genre == "장르") {
                    alert("장르를 선택해 주세요.");
                    return true;
                }
                return j == 9;
            });
        }

        /** 
         * 
         * 
         * json data api
         * 데이터 장소명을 중복없이 배열로 처리
         * search_map 함수 호출을 통해 지도에 표시
         */
        (async () => {
            
            let json = null;

            try {
                // test json
                const response = await axios.get('http://localhost:3001/response');
                json = response.data.body.items.item;
                // console.log(json);

                // API JSON ------------- 수정
                // const response = await axios.get('http://api.kcisa.kr/openapi/service/rest/meta16/getkopis01', {
                //     params: {
                //         serviceKey: "b5c0289f-a465-4bd4-bb80-37b3b12a1150",
                //         numOfRows: 100,
                //         pageNo: 1,
                //     },
                //     header: {
                //         accept: "application/json",
                //     },
                // });
                // json = response.data.response.body.items.item;
                // console.log(json);
            } catch (e) {
                console.error(e);
                alert('요청을 처리하는데 실패했습니다.');
                return;
            }
            /**
             * collectionDb: "kopis01_공연목록"
             * creator: "홈페이지"
             * language: "kor"
             * referenceIdentifier: "http://www.kopis.or.kr/upload/pfmPoster/PF_PF153974_190903_094953.gif"
             * spatialCoverage: "성남아트센터"
             * subDescription: "공연상태: 공연완료 오픈런: N"
             * subjectCategory: "콘서트"
             * temporalCoverage: "2019.12.07~2019.12.07"
             * title: "장윤정 라이브 콘서트 [성남]"
             * url: "http://www.kopis.or.kr/por/db/pblprfr/pblprfrView.do?menuId=MNU_00020&mt20Id=PF153974#20819"
            */
            
            // data의 장소 이름을 배열로 만듬
            let placeArray = [];
            json.forEach((v, i) => {
                placeArray.push(v.spatialCoverage);
            });
            // console.log(placeArray);

            // data의 장소 이름을 중복없는 배열로 만듬
            let placeName = Array.from(new Set(placeArray));
            console.log("지도에 표시한 장소");
            console.log(placeName);

            // placeName 반복을 검색 함수 파라미터로 보냄
            placeName.forEach((v, i) => {
                // search_map 함수 호출을 통해 지도에 표시
                search_map(v);
            });
        })();

        /** 
         * 
         * 
         * 지도 표시!!
         */
        // 마커를 클릭하면 장소명을 표출할 인포윈도우 입니다
        var infowindow = new kakao.maps.InfoWindow({zIndex:1});
        
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
                level: 8 // 지도의 확대 레벨
            };
        
        // 지도를 생성합니다    
        var map = new kakao.maps.Map(mapContainer, mapOption); 

        /** 
         * 
         * 
         * 지도 검색 및 마커 표시
         * placeName에서 이름을 가져와 지도에 검색 후 마커
         */
        function search_map(queryKeyword) {
            // 장소 검색 객체를 생성합니다
            var ps = new kakao.maps.services.Places(); 
            
            // 키워드로 장소를 검색합니다
            ps.keywordSearch(queryKeyword, placesSearchCB); 
            
            // 키워드 검색 완료 시 호출되는 콜백함수 입니다
            function placesSearchCB (data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
            
                    // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                    // LatLngBounds 객체에 좌표를 추가합니다
                    var bounds = new kakao.maps.LatLngBounds();
            
                    for (var i=0; i<data.length; i++) {
                        displayMarker(data[0]);
                        bounds.extend(new kakao.maps.LatLng(data[0].y, data[0].x));
                    }       
            
                    // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                    map.setBounds(bounds);
                } 
            }
            
            // 지도에 마커를 표시하는 함수입니다
            function displayMarker(place) {
                
                // 마커를 생성하고 지도에 표시합니다
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(place.y, place.x) 
                });
            
                // 마커에 클릭이벤트를 등록합니다
                kakao.maps.event.addListener(marker, 'click', function() {
                    // 마커를 클릭하면 장소명이 인포윈도우에 표출됩니다
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                    infowindow.open(map, marker);
                });
            }
        }

        /** 
         * 
         * 
         * 지도 확대 수준
        */
        // 지도 레벨은 지도의 확대 수준을 의미합니다
        // 지도 레벨은 1부터 14레벨이 있으며 숫자가 작을수록 지도 확대 수준이 높습니다
        function zoomIn() {        
            // 현재 지도의 레벨을 얻어옵니다
            var level = map.getLevel();
            
            // 지도를 1레벨 내립니다 (지도가 확대됩니다)
            map.setLevel(7);
        }    
        
        function zoomOut() {    
            // 현재 지도의 레벨을 얻어옵니다
            var level = map.getLevel(); 
            
            // 지도를 1레벨 올립니다 (지도가 축소됩니다)
            map.setLevel(10);
        }

        /** 
         * 
         * 
         * 지도 확대, 축소 가능 여부
         */
        // 버튼 클릭에 따라 지도 확대, 축소 기능을 막거나 풀고 싶은 경우에는 map.setZoomable 함수를 사용합니다
        function setZoomable(zoomable) {
            // 마우스 휠로 지도 확대,축소 가능여부를 설정합니다
            map.setZoomable(zoomable);    
        }
    </script>
</body>
</html>